machine:
  node:
    version: 6.9.2
  services:
    - docker

dependencies:
  pre:
  # Install hyper
    - wget https://hyper-install.s3.amazonaws.com/hyper-linux-x86_64.tar.gz
    - tar xzf hyper-linux-x86_64.tar.gz
    - chmod +x hyper
    - ./hyper --help
  # Install ffmpeg
    - sudo add-apt-repository --yes ppa:kirillshkrogalev/ffmpeg-next
    - sudo apt-get update
    - sudo apt-get install ffmpeg

deployment:
  encoder:
    tag: /encoder-prod-*/
    commands:
      # Logs in into docker, builds and pushes the firebase-fixer image
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker build -f dockerbuild/Dockerfile -t bespoken/encoder:$CIRCLE_TAG .
      - docker push bespoken/encoder:$CIRCLE_TAG
      # Configures, logs in and downloads the recently created image into hyper
      - ./hyper config --accesskey $HYPER_KEY --secretkey $HYPER_SECRET --default-region us-west-1
      - ./hyper login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - ./hyper pull bespoken/encoder:$CIRCLE_TAG
      # Removes previous container
      - ./hyper rm -f encoder || true
      # Runs a new container from the image
      - >
        ./hyper run -d
        -e SSL_CERT="$SSL_CERT"
        -e SSL_KEY="$SSL_KEY"
        -e SERVER_PORT=443
        --name encoder --size s4 --restart=always -P bespoken/encoder:$CIRCLE_TAG
      # Attaches a floating ip to the container
      - ./hyper fip attach 199.245.56.172 encoder
